---
title: '<div><img src="ohdsi40x40.png"></img> OHDSI GIS WG Geocoding Workflow </div>'
output:
   html_document:
        toc: TRUE
        toc_depth: 3
        toc_float:
          collapsed: false
---
```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
```

# Overview

This workflow demonstrates how to use the OHDSI Gaia suite of GIS tools to filter an existing OHDSI cohort, as defined in ATLAS, using geospatial data.

![Geocoding Workflow (Cohort Definitions) - [Click here to download](https://github.com/OHDSI/GIS/raw/main/rmd/images/geocodingSchemeCohorts.png)](images/geocodingSchemeCohorts.png){width=150%}

## Prerequisites

This workflow requires the `DatabaseConnector`, `ROhdsiWebApi`, and `CohortGenerator` packages. For this demonstration, we will be using the `Eunomia` package as the source OMOP database. We will be using the [Demo ATLAS](atlas-demo.ohdsi.org)
instance hosted by OHDSI.

```{r eval=FALSE}
install.packages("DatabaseConnector")
remotes::install_github("OHDSI/ROhdsiWebApi")
remotes::install_github("OHDSI/CohortGenerator")
remotes::install_github("OHDSI/Eunomia")
```

## Configuring Connection to the Servers
We need to configure connections to two servers: the server hosting the OMOP database and the server hosting the gaiaDB Postgres database.

### Connect to OMOP server:
```{r tidy=FALSE,eval=FALSE}
library(DatabaseConnector)
connectionDetails <- createConnectionDetails(
  dbms = "postgresql",
  server = "localhost/ohdsi",
  user = "myUser",
  password = "mySecretPassword"
)
```

For the purposes of this example, we will use the Eunomia test CDM package that is in an Sqlite database stored locally.
```{r results = FALSE,message = FALSE,warning=FALSE, message = FALSE,eval=FALSE}
connectionDetails <- Eunomia::getEunomiaConnectionDetails()
cdmDatabaseSchema <- "main"
tempEmulationSchema <- NULL
cohortDatabaseSchema <- "main"
cohortTable <- "cohort"
```

### Connect to gaiaDB server:
If you don't already have a gaiaDB server set up, see the [installation instructions](https://ohdsi.github.io/GIS/installation.html#gaiaDB_database) before proceeding.
```{r tidy=FALSE,eval=FALSE}
library(DatabaseConnector)
gaiaConnectionDetails <- DatabaseConnector::createConnectionDetails(
  dbms = "postgresql",
  server = "localhost/gaiaDB",
  port = 5432,
  user="postgres",
  password = "mySecretPassword") 
```


## Step 1. Define a cohort using ATLAS
Use the OHDSI ATLAS tool to define a cohort 

## Step 2. Import the ATLAS Cohort Definition to R
Use the ROhdsiWebApi tool to import cohort definition to R

## Step 3. Generate Cohort from the Cohort Definition
Use the CohortGenerator tool to generate a cohort from the cohort definition

## Step 4. Ingest Addresses from OMOP Database
TODO: This should be a single function in gaiaCore
WIP [getCohortAddresses](https://github.com/OHDSI/GIS/issues/170)

## Step 5. Geocode Addresses without Coordinates
TODO: This should be a single function in gaiaCore
WIP [geocodeCohort](https://github.com/OHDSI/GIS/issues/162)

## Step 6. Import Geocoded Cohort to gaiaDB Database
TODO: This should be a single function in gaiaCore
WIP [importCohort](https://github.com/OHDSI/GIS/issues/171)

## Step 7. Filter Cohort using PostGIS Functionality










