---
title: '<div><img src="ohdsi40x40.png"></img> OHDSI GIS WG Geocoding Workflow </div>'
output:
   html_document:
        toc: TRUE
        toc_depth: 3
        toc_float:
          collapsed: false
---
```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
```

# Overview

This workflow demonstrates how to use the OHDSI Gaia suite of GIS tools to geocode the entirety of an OMOP Location table, fully enabling any further geospatial analyses supported by the Gaia GIS tools.

![Geocoding Workflow (Cohort Definitions) - [Click here to download](https://github.com/OHDSI/GIS/raw/main/rmd/images/geocodingSchemeFull.png)](images/geocodingSchemeFull.png){width=150%}

## Prerequisites

This workflow requires the `DatabaseConnector` package.

```{r eval=FALSE}
install.packages("DatabaseConnector")
library(DatabaseConnector)
```

## Configuring Connection to the Servers
We need to configure connections to two servers: the server hosting the OMOP database and the server hosting the gaiaDB Postgres database.

### Connect to OMOP server:
```{r tidy=FALSE,eval=FALSE}
connectionDetails <- createConnectionDetails(
  dbms = keyring::key_get('cdm-dbms'), 
  user = keyring::key_get('cdm-username'), 
  password = keyring::key_get('cdm-password'), 
  server = keyring::key_get('cdm-server')
)
```

### Connect to gaiaDB server:
If you don't already have a gaiaDB server set up, see the [installation instructions](https://ohdsi.github.io/GIS/installation.html#gaiaDB_database) before proceeding.
```{r tidy=FALSE,eval=FALSE}
library(DatabaseConnector)
gaiaConnectionDetails <- DatabaseConnector::createConnectionDetails(
  dbms = "postgresql",
  server = "localhost/gaiaDB",
  port = 5432,
  user="postgres",
  password = "mySecretPassword") 
```

## Step 1. Ingest the Location table from OMOP Database
Use the gaiaCore function `getLocationAddresses()` to extract addresses from OMOP
and return a transformed location table:
``` {r eval=FALSE}
transformedLocation <- getLocationAddresses(connectionDetails = connectionDetails,
                                            cdmDatabaseSchema = cdmDatabaseSchema)
```

## Step 2. Split the transformedLocation dataframe into two tables based on whether it already contains latitude and longitude information:
``` {r eval=FALSE}
splitResult <- splitAddresses(addressTable = transformedLocation)

alreadyGeocodedLocation <- splitResult$geocoded

notGeocodedLocation <- splitResult$ungeocoded
```

## Step 3. Geocode Addresses without Coordinates
``` {r eval=FALSE}
geocodedCohort <- geocodeAddresses(addressTable = notGeocodedLocation)
```

## Step 6. Import Geocoded Cohort to gaiaDB Database
``` {r eval=FALSE}
importCohortTable(gaiaConnectionDetails = gaiaConnectionDetails,
                  cohort = geocodedCohort)
```

## Step 7. Filter Cohort using PostGIS Functionality
We are going to filter the cohort based on proximity to a temperature sensor. For
this example, we only want to include patients whose current address is within 
about 11.1 km of an EPA air temperature sensor that recorded a temperature greater
than 101 degrees Fahrenheit in 2018, 2019, or 2020:
``` {r eval=FALSE}
conn <-  DatabaseConnector::connect(gaiaConnectionDetails)

x <- DatabaseConnector::querySql(conn, sql ="select *
    from cohort.cohort_", 1782669, " ct
    where exists (
    	select 1
    	from (
    		select *
	-- This join is ideally made automatically. User should specify a variable (by name)
	-- and threshold (i.e. 101 deg F, 11km radius)
  -- This union is also ideally automatic. In the case of no time constraint, it 
  -- should union all attr_daily_temp_*
    		from (
    			select * from 
    			epa_aqs.attr_daily_temp_2020 a20
    			union
    			select * from
    			epa_aqs.attr_daily_temp_2019 a19
    			union
    			select * from
    			epa_aqs.attr_daily_temp_2018 a18
    		)  adt
    		inner join epa_aqs.geom_aqs_sites gas 
    		on adt.geom_record_id = gas.geom_record_id 
    		and variable_source_record_id IN (29, 27, 25)
    		and value_as_number > 101
    	) c
    	where st_distance(
    		ct.geometry,
    		c.geom_local_value) < .1 -- degrees, approx 11.1km		
    	)")

DatabaseConnector::disconnect(conn)
```









